{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="row">
        <section class="col-md-12">
            <h1 class="page-header text-center">Live Sensor Data</h1>
            <p class="text-center text-muted">&nbsp&nbsp&nbspHere you can see the live status of sensors in map</p>

            <!-- Table content -->
            <div class="row">
                <div class="form-group">
                    <form class="form-horizontal" method="post" enctype="multipart/form-data">{% csrf_token %}
                        <div class="form-group col-md-12">
                            <div class="col-md-12">
                                <div class="col-md-4">
                                    <label for="" class="" id="">1. Choose Mine:</label>
                                </div>
                                <div class="col-md-8">
                                    {{form.mine_id}}
                                </div>
                            </div>
                        </div>
                        <div class="text-center">
                            <button type="button" id="show" class="btn btn-success" value="Show">Show</button>
                        </div>
                    </form>
                </div>
            </div>
        </section>

    </div>

</div><section class="KBmap" id="KBtestmap"></section>

<script type="text/javascript">
    $(document).ready(function(){
            $("#id_mine_id").addClass('form-control');
             toastr.options = {
                    "closeButton": false,
                    "debug": false,
                    "newestOnTop": true,
                    "progressBar": false,
                    "positionClass": "toast-bottom-full-width",
                    "preventDuplicates": true,
                    "onclick": null,
                    "showDuration": "300",
                    "hideDuration": "100",
                    "timeOut": "3000",
                    "extendedTimeOut": "1000",
                    "showEasing": "swing",
                    "hideEasing": "linear",
                    "showMethod": "fadeIn",
                    "hideMethod": "fadeOut",
                    }

    });
    $("#id_mine_id").on("change",function(){
    if($(this).val()!=''){
        setImageData(this.value);
        $('#RouterCreate').prop("disabled", false)
    }
    else{
        $('#RouterCreate').prop("disabled", true)
    }
    $('#KBtestmap').hide();
});

$('#show').click(function(){
    //console.log('here');
    $('#KBtestmap').show()
})
var tempData1,tempData2;
function setImageData(mine_id){
    url=$("#get_url").data('url');

        $.ajax({
            type:"get",
            url: "{% url 'sensor:fetch_map_image' %}",
            data: {
                     'id': mine_id
                   },
            success: function(data) {
                // CreateMapModel(data.mine.image_url,data.result.name);
                tempData1=data;
                  CreateKBtestMap(data);
                      $('div.KBmap__marker').click(function(){
                            console.log('here');
                            var NodeId=this.id;
                            var NodeName=this.dataset.markerName;
                            var mine_id=$("#id_mine_id").val();
                            console.log(NodeId+" "+NodeName+" "+mine_id);
                            Show_Live_Sensor_Values(mine_id,NodeId,NodeName);
                        });

                    },
            error: function(){
                    console.log("something is not right.please contact admin - 1");
                 }
            });
}
function CreateKBtestMap(data){
            var img=data.mine.image_url;

            //console.log(url);
         if(addedKBmaps.length>0){
            addedKBmaps.pop();
            $('.KBmap__mapContainer').remove();
         }

        //alert(img);

        if(img){
        createKBmap('KBtestmap', '/media/'+img);
			    KBtestmap.importJSON(data.node);


				KBtestmap.showAllMapMarkers();
				for(d in data.node){
			         $('div.KBmap__marker.'+d)[0]['id']=data.node[d]['id'];
			    }
				}
        else{
            $("#map").css("");
            $("#map").html("No Mine map(blue print) is added in this mine.please add it.");
        }
    };

var NODEAJAX;

function Show_Live_Sensor(mine_id,data){
    for(node in data){
        Show_Live_Sensor_Values(mine_id,data[node]['id'],node);
    }
};


function Show_Live_Sensor_Values(mine_id,node_id,node_name){
      NODEAJAX=setInterval(function () {
          $.ajax({
                type:"get",
                url: "{% url 'sensor:node_sensor_data' %}",
                data: {
                         'id': mine_id,
                         'node_id':node_id,
                         'node_name':node_name,
                       },
                success: function(data) {
                    tempData2=data;
                    if(data.hasOwnProperty("error")){
                     toastr.error(data.error);
                     return data;
                  }
                  console.log(data);
                  Fill_Node(data)
                  return data;
                },
                error: function(){
                        console.log("something is not right.please contact admin - 1");
                     }
                });
          },2000);
};
var set=0;

function Fill_Node(NODE){
    contents="";
   for(node in NODE){
        contents='<div id="Content'+node+'">';
        for(gases in NODE[node]){
            var gas=NODE[node][gases];
            var progressBarColor="#49FB7A"; //green  F6FE51 //yellow  FB2E1D //red
            if(gas.value<10){
                progressBarColor="#49FB7A";
            }
            else if(gas.value>10 && gas.value<20){
                progressBarColor="#F6FE51";
            }
            else{
                progressBarColor="#FB2E1D";
            }
            contents+='<div id="'+gases+'"><strong>'+gases+':</strong> '+gas.value+' '+gas.unit+'<div class="progress"><div class="progress-bar"  role="progressbar" aria-valuenow="70" aria-valuemin="0" aria-valuemax="100" style="background-color='+progressBarColor+' width:'+gas.value+'%"><span class="sr-only">70% Complete</span></div></div></div>';
            }
        contents+='</div>';
        if(set==0){KBtestmap.mapMarkers[node].modal.content=contents;}
        for(gases in NODE[node]){
            var gas=NODE[node][gases];
            var progressBarColor="49FB7A"; //green  F6FE51 //yellow  FB2E1D //red
            console.log(gas.value);
            if(gas.value<10){
                progressBarColor="#49FB7A";
            }
            else if(gas.value>10 && gas.value<20){
                progressBarColor="#F6FE51";
            }
            else{
                progressBarColor="#FB2E1D";
            }
            console.log(progressBarColor);
            console.log(gas.value);
            $('div#Content'+node).children('#'+gases).html('<strong>'+gases+':</strong> '+gas.value+' '+gas.unit+'<div class="progress"><div class="'+node+' progress-bar '+gases+'" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width:'+parseFloat(gas.value)+'%"><span class="sr-only">70% Complete</span></div></div></div>')
            $("div."+node+".progress-bar."+gases).css('background-color', progressBarColor);
         }
   }

}


</script>


{% endblock %}