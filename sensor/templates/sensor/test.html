<html>
<head>
    <title>Ellicots Graph</title>
    {% load staticfiles %}
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="{% static 'image/csir_logo.ico' %}" type="image/icon type">
    <link rel="shortcut icon" href="{% static 'image/favicon.ico' %}" type="image/icon type">
    <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}">
    <link rel="stylesheet" href="{% static 'css/bootstrap-datetimepicker.min.css' %}">
    <script src="{% static 'js/jquery-3.3.1.min.js' %}"></script>
    <link href="https://fonts.googleapis.com/css?family=Montserrat:200,400,700" rel="stylesheet">
    <style>
        * {
            -webkit-box-sizing: border-box;
            box-sizing: border-box;
        }

        body {
            padding: 0;
            margin: 0;
        }

        #notfound {
            position: relative;
            height: 30vh;
        }

        #notfound .notfound {
            position: absolute;
            left: 50%;
            top: 50%;
            -webkit-transform: translate(-50%, -50%);
            -ms-transform: translate(-50%, -50%);
            transform: translate(-50%, -50%);
        }

        .notfound {
            max-width: 520px;
            width: 100%;
            line-height: 1.4;
            text-align: center;
        }

        .notfound .notfound-404 {
            position: relative;
            height: 200px;
            margin: 0px auto 20px;
            z-index: -1;
        }

        .notfound .notfound-404 h1 {
            font-family: 'Montserrat', sans-serif;
            font-size: 236px;
            font-weight: 200;
            margin: 0px;
            color: #211b19;
            text-transform: uppercase;
            position: absolute;
            left: 50%;
            top: 50%;
            -webkit-transform: translate(-50%, -50%);
            -ms-transform: translate(-50%, -50%);
            transform: translate(-50%, -50%);
        }

        .notfound .notfound-404 h2 {
            font-family: 'Montserrat', sans-serif;
            font-size: 18px;
            font-weight: 400;
            text-transform: uppercase;
            color: #211b19;
            background: #fff;
            padding: 10px 5px;
            margin: auto;
            display: inline-block;
            position: absolute;
            bottom: 0px;
            left: 0;
            right: 0;
        }

        .notfound a {
            font-family: 'Montserrat', sans-serif;
            display: inline-block;
            font-weight: 700;
            text-decoration: none;
            color: #fff;
            text-transform: uppercase;
            padding: 13px 23px;
            background: #ff6300;
            font-size: 18px;
            -webkit-transition: 0.2s all;
            transition: 0.2s all;
        }

        .notfound a:hover {
            color: #ff6300;
            background: #211b19;
        }

        @media only screen and (max-width: 767px) {
            .notfound .notfound-404 h1 {
                font-size: 148px;
            }
        }

        @media only screen and (max-width: 480px) {
            .notfound .notfound-404 {
                height: 148px;
                margin: 0px auto 10px;
            }

            .notfound .notfound-404 h1 {
                font-size: 86px;
            }

            .notfound .notfound-404 h2 {
                font-size: 16px;
            }

            .notfound a {
                padding: 7px 15px;
                font-size: 14px;
            }
        }


        .loader-container {
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-align: center;
            -ms-flex-align: center;
            align-items: center;
            -webkit-box-pack: center;
            -ms-flex-pack: center;
            justify-content: center;
            min-height: 30vh;
        }

        .loader {
            max-width: 15rem;
            width: 100%;
            height: auto;
            stroke-linecap: round;
        }

        circle {
            fill: none;
            stroke-width: 3.5;
            -webkit-animation-name: preloader;
            animation-name: preloader;
            -webkit-animation-duration: 3s;
            animation-duration: 3s;
            -webkit-animation-iteration-count: infinite;
            animation-iteration-count: infinite;
            -webkit-animation-timing-function: ease-in-out;
            animation-timing-function: ease-in-out;
            -webkit-transform-origin: 170px 170px;
            transform-origin: 170px 170px;
            will-change: transform;
        }

        circle:nth-of-type(1) {
            stroke-dasharray: 550;
        }

        circle:nth-of-type(2) {
            stroke-dasharray: 500;
        }

        circle:nth-of-type(3) {
            stroke-dasharray: 450;
        }

        circle:nth-of-type(4) {
            stroke-dasharray: 300;
        }

        circle:nth-of-type(1) {
            -webkit-animation-delay: -0.15s;
            animation-delay: -0.15s;
        }

        circle:nth-of-type(2) {
            -webkit-animation-delay: -0.3s;
            animation-delay: -0.3s;
        }

        circle:nth-of-type(3) {
            -webkit-animation-delay: -0.45s;
            -moz-animation-delay: -0.45s;
            animation-delay: -0.45s;
        }

        circle:nth-of-type(4) {
            -webkit-animation-delay: -0.6s;
            -moz-animation-delay: -0.6s;
            animation-delay: -0.6s;
        }

        @-webkit-keyframes preloader {
            50% {
                -webkit-transform: rotate(360deg);
                transform: rotate(360deg);
            }
        }

        @keyframes preloader {
            50% {
                -webkit-transform: rotate(360deg);
                transform: rotate(360deg);
            }
        }
    </style>
</head>
<body>
<div class="container">
    <section class="col-md-12">
        <form method="post" enctype="multipart/form-data">
            <input type="hidden" value="{{ node_id|encrypt }}" id="node_id" data-url="{% url 'sensor:ellicots_ajax' %}">
            <div class="row">
                <div class="col-md-12">
                    <h3 class="page-header text-center"><b>Ellicots Extension Graph</b></h3>
                    {% csrf_token %}
                    <div class="col-md-2">
                        {#                    <label> Select Mine </label><span id="mine_id_span">{{ form.mine }}</span><br>#}
                    </div>
                    <div class="col-md-4">
                        <div class="input-group date" id="date_from_time_picker">
                            <input type="text" name="date_of_opening" class="form-control" placeholder="From Date"
                                   id="id_date_fr" required="" autocomplete="off">

                            <span class="input-group-addon"><span class="glyphicon glyphicon-calendar"></span></span>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="input-group date" id="date_to_time_picker">
                            <input type="text" name="date_of_opening" class="form-control" placeholder="To Date"
                                   id="id_date_to" required="" autocomplete="off">

                            <span class="input-group-addon"><span class="glyphicon glyphicon-calendar"></span></span>
                        </div>
                    </div>
                </div>
            </div>
        </form>
        <div class="row">
            <div class="text-center">
                <button id="btn_show" class="btn btn-primary">Show Graph</button>
            </div>
            <div class="loader-container" hidden>
            <svg class="loader" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 340 340">
                <circle cx="170" cy="170" r="160" stroke="#E2007C"/>
                <circle cx="170" cy="170" r="135" stroke="#404041"/>
                <circle cx="170" cy="170" r="110" stroke="#E2007C"/>
                <circle cx="170" cy="170" r="85" stroke="#404041"/>
            </svg>
        </div>
        </div>
        <div id="linechart" class="text-center col-md-12"></div>
        <div id="notfound" hidden>
            <div class="notfound">
                <div class="notfound-404">
                    <h1>Oops!</h1>
                    <h2>404 - Data not found. Please Try Again Later!</h2>
                </div>

            </div>
        </div>

    </section>
</div>

<script src="{% static 'js/bootstrap.min.js' %}"></script>
<script src="{% static 'datetime/js/moment.js' %}"></script>
<script src="{% static 'datetime/js/moment-with-locales.js' %}"></script>
<script src="{% static 'datetime/js/collapse.js' %}"></script>
<script src="{% static 'datetime/js/transition.min.js' %}"></script>
<script src="{% static 'datetime/js/bootstrap-datetimepicker.min.js' %}"></script>
<script src="{% static 'js/plotly-latest.min.js' %}"></script>
<script src="{% static 'js/customJS.js' %}"></script>
<script>
    $(document).ready(function () {
        let date_from = $('#date_from_time_picker').datetimepicker({
            format: 'YYYY-MM-DD'
        });
        let date_to = $('#date_to_time_picker').datetimepicker({
            format: 'YYYY-MM-DD'
        });
        $('.loader-container').hide();
        EEllicots();

        function EEllicots() {


            function GRAPH(url, id, from, to) {
                $.ajax({
                        type: "get",
                        url: url,
                        data: {
                            {{ 'id' }}: id,
                            'date_from': from,
                            'date_to': to,
                        },
                        beforeSend: function () {

                            Plotly.purge('linechart');

                            $('#notfound').hide();
                            $('.loader-container').show();
                            $('#btn_show').prop('disabled',true);
                        },
                        success: function (data) {
                            if (data.hasOwnProperty('result') && !isEmpty(data.result)) {
                                let result = data.result;
                                let x_list = [];
                                let y_list = [];
                                let text = [];
                                let color = [];
                                let dates = [];
                                for (let r in result) {
                                    if (result.hasOwnProperty(r)) {
                                        x_list.push(result[r].x);
                                        y_list.push(result[r].y);
                                        text.push(x_list.length.toString());
                                        color.push(result[r].color);
                                        dates.push(result[r].dates);
                                    }
                                }
                                var xhighest = Math.max.apply(Math, x_list);
                                var xlowest = Math.min.apply(Math, x_list);
                                var yhighest = Math.max.apply(Math, y_list);
                                var ylowest = Math.min.apply(Math, y_list);
                                var highest = Math.max.apply(Math, [Math.abs(xhighest), Math.abs(xlowest), Math.abs(yhighest), Math.abs(ylowest)]);
                                var ellicots_trace = {
                                    x: x_list,
                                    y: y_list,
                                    xa: [],
                                    mode: 'text+dates+markers',
                                    type: 'scatter',
                                    name: [],
                                    text: text,
                                    textfont: {
                                        {#family: 'sans serif',#}
                                        size: 20,
                                        color: color,
                                        weight: '900'
                                    },
                                    {#marker: {size: date.toString(),},#}
                                    textposition: 'bottom center',

                                    hoveron: 'points',

                                    {#hovertemplate: "<b>%{name}<b><extra></extra>",#}
                                    hovertext: dates,

                                    {#hoverinfo: 'x+y',#}
                                };


                                var data = [ellicots_trace];
                                var layout = {
                                    title: 'Ellicott\'s Explosibility Graph',
                                    titlefont: {
                                        size: 32
                                    },
                                    width: 1200,
                                    height: 800,

                                    xaxis: {
                                        title: "<b>(EFFECTIVE INSERT GASES IN %)</b>",
                                        tickmode: "linear", //  If "linear", the placement of the ticks is determined by a starting position `tick0` and a tick step `dtick`
                                        tick0: 0,
                                        dtick: 10,
                                        autoscale: true,
                                        range: [-highest * 1.3, highest * 1.3],
                                        {#range: [-100, 100],#}
                                        ticks: "outside",
                                        showgrid: true,
                                        zeroline: true,
                                        showline: true,
                                        mirror: 'ticks',
                                        gridcolor: '#bdbdbd',
                                        gridwidth: 0.05,
                                        zerolinecolor: '#969696',
                                        zerolinewidth: 3,
                                        linecolor: '#636363',
                                        linewidth: 6,
                                        {#side:'right'#}
                                    },
                                    yaxis: {
                                        title: "<b>(TOTAL EFFECTIVE COMBUSTIBLE IN %)</b>",
                                        tickmode: "linear", //  If "linear", the placement of the ticks is determined by a starting position `tick0` and a tick step `dtick`
                                        tick0: 0,
                                        dtick: 15,
                                        autoscale: true,
                                        {#yanchor:'right',#}
                                        ticks: 'inside',

                                        range: [-highest * 1.3, highest * 1.3],
                                        {#range: [-30, 30],#}
                                        showgrid: true,
                                        zeroline: true,
                                        showline: true,
                                        mirror: 'ticks',
                                        gridcolor: '#bdbdbd',
                                        gridwidth: 0.15,
                                        zerolinecolor: '#969696',
                                        zerolinewidth: 3,
                                        linecolor: '#636363',
                                        linewidth: 6,

                                    },
                                    annotations: [
                                        {
                                            x: -highest,
                                            y: highest,
                                            text: '<b>CLEAN FUEL NON-EXPLOSIVE</b>',
                                            bgcolor: "#ff7f0e",
                                            showarrow: false,
                                        },
                                        {
                                            x: highest,
                                            y: highest,
                                            text: '<b>EXPLOSIVE</b>',
                                            bgcolor: "#ff7f0e",
                                            showarrow: false,
                                        },
                                        {
                                            x: -highest,
                                            y: -highest,
                                            text: '<b>NON COMBUSTIBLE NON-EXPLOSIVE</b>',
                                            bgcolor: "#ff7f0e",
                                            showarrow: false,
                                        },
                                        {
                                            x: highest,
                                            y: -highest,
                                            text: '<b>POTENTIALLY EXPLOSIVE</b>',
                                            bgcolor: "#ff7f0e",
                                            showarrow: false,
                                        }
                                    ],

                                    showlegend: false
                                };
                                Plotly.newPlot('linechart', data, layout, {modeBarButtonsToRemove: ['autoScale2d']});
                                {#Plotly.relayout('linechart', relayout);#}
                                {#Plotly.extendTraces('linechart', update, [0], [10]);#}

                            } else {
                                $('#notfound').show();
                            }
                        },
                    complete:function(){
                       $('.loader-container').hide();
                       $('#btn_show').prop('disabled',false);
                    },
                        error: function () {
                            console.log("Something Went Wrong!");
                            {#alert("Please select Mine and location to see graph")#}
                        }
                        ,
                    }
                );
            }

            $('#btn_show').click(function () {
                let endpoint = $('#node_id').data('url');
                let id = $('#node_id').val();
                let from = $('#id_date_fr').val();
                let to = $('#id_date_to').val();
                console.log(endpoint, id, from, to);
                if (!isEmpty(from) && !isEmpty(to)) {
                    console.log('clicked in');
                    GRAPH(endpoint, id, from, to)
                } else {
                    let from = "1899-01-01";
                    let to = "2999-12-12";
                    GRAPH(endpoint, id, from, to)
                }
            });
        }

    });
</script>
</body>
</html>
