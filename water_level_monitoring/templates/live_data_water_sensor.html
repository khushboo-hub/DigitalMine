{% extends "base.html" %}
{% block content %}
<head>
    <style>
    .margin_top{
     margin-top: 15px;
    }
.dt-buttons{
    z-index: 1 !important;
    margin-bottom: -20px;
}
</style>
</head>
<div class="container">
    <div class="row">
        <section class="col-md-12">
            <h1 class="page-header"><b>LIVE WATER LEVEL MONITORING TABLE</b><small> Here we can view live data</small></h1>
            <div class="row margin_top">
                <div class="col-md-2">
                     <label for="" class="" id="">Choose Mine:</label>
                </div>
                <div class="col-md-4">
                    {{form.mine_id}}
                </div>
                <div class="col-md-2">
                    <label for="" class="" id="">Choose Location:</label>
                </div>
                <div class="col-md-4">
                    <select class="form-control" id="id_location_list">
                        <option value="">--Select Location--</option>
                    </select>
                </div>
            </div>
            <div class="row margin_top">
                <div class="col-md-2">
                     <label for="" class="" id="">Wireless data is comming from IP:</label>
                </div>
                <div class="col-md-4">
                     <input type="text" class="form-control" readonly id="ip_hidden">
                </div>
                <div class="col-md-6">
                     <div class="text-left">
                        <input type="button" id="btn_show" class="btn btn-primary" value="Show"/>
                     </div>
                </div>
            </div>
            <div class="col-md-12" style="margin-top:15px;">
            <div class="table-responsive">
                <table class="table table-bordered" id="sensor_content">
                    <thead>
                        <tr>
                            <th>Date Time</th>
                            <th>Mine Name</th>
                            <th>Location Name</th>
                            <th>Water Level</th>
                        </tr>
                    </thead>
                    <tbody id="sensor_content_body">

                    </tbody>
                </table>
            </div>
        </div>
        </section>

    </div>
</div>
<br/>
<br/>
 <script src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
 <script src="https://cdn.datatables.net/buttons/1.5.6/js/dataTables.buttons.min.js"></script>
 <script src="https://cdn.datatables.net/buttons/1.5.6/js/buttons.flash.min.js"></script>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
 <script src="https://cdn.datatables.net/buttons/1.5.6/js/buttons.html5.min.js"></script>
 <script src="https://cdn.datatables.net/buttons/1.5.6/js/buttons.print.min.js"></script>
<script>
 $("#id_mine_id").addClass('form-control');
$(document).ready(function() {
   d_table();
} );
 //------------------------------------------------------------------------------------------------------------------
    $("#id_mine_id").on("change",function(){
        mine_id=this.value;
        $.ajax({
            type:"get",
            url: "{% url 'water_level_monitoring:fetch_location_ajax' %}",
            data: {
                     'id': mine_id
                   },
            success: function(data) {
                fill_dropdown(data.result);
                    },
            error: function(){
                    console.log("something went wrong");
                 }
        });
    });
    //------------------------------------------------------------------------------------------------------------------
     function fill_dropdown(result){
        $("#id_location_list").html("<option value=''>--Select Location--</option>");
        for (index = 0; index < result.length; index++) {
            var str_array = result[index].split(',');
            $("#id_location_list").append($("<option />").val(str_array[0]).text(str_array[1]));
        }
    }
    //------------------------------------------------------------------------------------------------------------------
    //------------------------------------------------------------------------------------------------------------------
    var l_color = "#C0DF81";
     var m_color = "#FEFE9A";
     var h_color = "#F37C84";

     var l_value = "";
     var m_value = "";
     var h_value = "";
     var t_hight = 0;

       var audio_type = "";
     var first_warning = "";
     var second_warning = "";
     var third_warning = "";

     var first_audio = "";
     var second_audio = "";
     var third_audio = "";

    $("#id_location_list").on("change",function(){
        location_id=this.value;
        $.ajax({
                type:"get",
                url: "{% url 'water_level_monitoring:fetch_sensor_details' %}",
                data: {
                    'id': location_id
                    },
                success: function(data) {
                        console.log(data);
                     for(index = 0; index < data.result.length; index++) {
                            var str_array = data.result[index].split('@#');
                            console.log(str_array);
                             $("#ip_hidden").val(str_array[0]);
                                l_value = str_array[1];
                                m_value = str_array[2];
                                h_value = str_array[3];
                                t_hight = str_array[4];

                                audio_type = str_array[5];
                                first_warning =  str_array[6];
                                second_warning = str_array[7];
                                third_warning = str_array[8];

                                first_audio =  str_array[9];
                                second_audio = str_array[10];
                                third_audio =  str_array[11];

                        }
                 },
                error: function(){
                        console.log("something went worng");
                     }
         });
    });
     //------------------------------------------------------------------------------------------------------------------

    $(document.body).on('click','#btn_show',function(){
         var warning_validation = 1;
        var location = $("#id_location_list").val();
        if(location){
                $("#btn_show").val("Please wait...");
                $("#btn_show").prop('disabled', true);
                location=$("#id_location_list").val();
                if(location == ""){
                    alert("Please Choose location");
                    $("#btn_show").val("Show");
                    $("#btn_show").prop('disabled', false);
                }else{
                    $("#sensor_content_body").empty();//empty the table on each click
                    setInterval(function(){
                            $.ajax({
                            type:"get",
                            url: "{% url 'water_level_monitoring:fetch_water_level_ajax' %}",
                            data: {
                                     'id': location
                                   },
                            success: function(data) {
                                console.log(data.result);
                                 fill_table_sensor(data.result);
                                    },
                            error: function(){
                                    console.log("error he ji");
                                 }
                            });
                    }, 1000);//time in milliseconds
                }
        }else{
        alert("Please choose location");
        }
    });
function fill_table_sensor(result){

        if ( $.fn.DataTable.isDataTable('#sensor_content') ) {
          $('#sensor_content').DataTable().destroy();
        }

        for (index = 0; index < result.length; index++) {
            var str_array = result[index].split(',');
            $("#ip_hidden").val(str_array[1]);
            var final_value = ((t_hight - str_array[5]) >0 ? (t_hight - str_array[5]) : 0);
            checkAndPlay(final_value);
            $("#sensor_content").prepend($("<tr bgcolor='#ADFF2F'><td>"+str_array[2]+"</td><td>"+str_array[3]+"</td><td>"+str_array[4]+"</td><td>"+final_value+" cm</td></tr>"));
        }
        d_table();
        $("#btn_show").val("Show");
        $("#btn_show").prop('disabled', false);
    }
     function d_table(){
         $('#sensor_content').DataTable({
                paging: false,
                searching: true,
                "ordering": false,
                dom: 'Bfrtip',
                buttons: [
                    'copy', 'csv', 'excel', 'pdf', 'print'
                ]
         });
    }


    function checkAndPlay(sensorValue){

    var loc = window.location;
    var baseUrl = loc.protocol + "//" + loc.hostname + (loc.port? ":"+loc.port : "") + "/media/" ;

    if((l_value < sensorValue)&&(sensorValue < m_value)){//low level
        $.toast({
            heading: '<b>Water Level Monitoring : First Level Warning</b>',
            text: first_warning,
            showHideTransition: 'fade',
            position: 'bottom-right',
            icon: 'error'
        })
        if(audio_type =="text2voice"){
             Speak(first_warning,9,0.5);
        }else{
            path = baseUrl+first_audio;
            var playNow = new Audio(path);
            playNow.play();
        }
    }
    if((m_value < sensorValue) && (sensorValue < h_value)){//middle level
        $.toast({
            heading: '<b>Water Level Monitoring : Second Level Warning </b>',
            text: second_warning,
            showHideTransition: 'fade',
            position: 'bottom-right',
            icon: 'error'
        })
         if(audio_type =="text2voice"){
             Speak(second_warning,9,0.5);
         }else{
              path = baseUrl+second_audio;
             var playNow = new Audio(path);
             playNow.play();
         }
    }
    if(sensorValue > h_value) {//high level
        $.toast({
            heading: '<b>Water Level Monitoring : Third Level Warning</b> ',
            text: third_warning,
            position: 'bottom-right',
            showHideTransition: 'fade',
            icon: 'error'
        })
        if(audio_type =="text2voice"){
              Speak(third_warning, 9, 0.5);
        }else{
             path = baseUrl+third_audio;
             var playNow = new Audio(path);
            playNow.play();
        }
    }
}
</script>
</body>
{% endblock %}