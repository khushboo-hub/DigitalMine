{% extends "base.html" %}
{% block content %}
    <style>
        .margin_top {
            margin-top: 15px;
        }
    </style>
    <div class="container">
        <script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>
        <div class="row">
            <section class="col-md-12">
                <h2 class="page-header" style="text-align: left;"><b>STRATA LIVE GRAPH</b>
                    <small> Here we can view strata live graph</small>
                </h2>
                <div class="row margin_top">
                    <div class="col-md-2">
                        <label for="" class="" id="">Choose Mine:</label>
                    </div>
                    <div class="col-md-4">
                        {{ form.mine_name }}
                    </div>
                    <div class="col-md-2">
                        <label for="" class="" id="">Choose Location:</label>
                    </div>
                    <div class="col-md-4">
                        <select class="form-control" id="id_location_list">
                            <option>--Select Location--</option>
                        </select>
                    </div>
                </div>
                <div class="row margin_top">
                    <div class="col-md-2">
                        <label for="" class="" id="">Choose Sensor:</label>
                    </div>
                    <div class="col-md-4">
                        <select class="form-control" id="id_sensor_list">
                            <option value="">--Select Sensor--</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="" class="" id="">Wireless data is comming from IP:</label>
                    </div>
                    <div class="col-md-4">
                        <input type="text" class="form-control" readonly id="ip_hidden">
                    </div>
                </div>
                <div class="row margin_top">
                    <div class="text-center">
                        <input type="button" id="btn_show" class="btn btn-primary" value="Show"/>
                    </div>
                </div>

            </section>
        </div>
    </div>
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-1" style="margin-top:14%;transform: rotate(270deg);font-weight:bold;"
                 id="unit_sensor"></div>
            <div class="col-md-11" style="margin-top:15px;">
                <div class="table-responsive">
                    <div id="chartContainer" style="height: 600px; width:100%;"></div>
                    <div id="current_date" style="display:none">
                        <center><b>Date : {% now "jS F Y" %}</b></center>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        $(document).ready(function () {
            $("#id_mine_name").addClass('form-control');
            //------------------------------------------------------------------------------------------------------------------
            $("#id_mine_name").on("change", function () {
                mine_id = this.value;
                $.ajax({
                    type: "get",
                    url: "{% url 'Strata:fetch_location_ajax' %}",
                    data: {
                        'id': mine_id
                    },
                    success: function (data) {
                        fill_dropdown(data.result);
                        return data;
                    },
                    error: function () {
                        console.log("something went wrong");
                    }
                });
            });

            //------------------------------------------------------------------------------------------------------------------
            function fill_dropdown(result) {
                $("#id_location_list").html("<option value=''>--Select Location--</option>");
                for (index = 0; index < result.length; index++) {
                    var str_array = result[index].split(',');
                    $("#id_location_list").append($("<option />").val(str_array[0]).text(str_array[1]));
                }
            }

            //------------------------------------------------------------------------------------------------------------------
            $("#id_location_list").on("change", function () {
                location_id = this.value;
                $.ajax({
                    type: "get",
                    url: "{% url 'Strata:fetch_sensor_ajax' %}",
                    data: {
                        'id': location_id
                    },
                    success: function (data) {
                        //console.log(data.result);
                        //alert(data.result[0]);
                        fill_dropdown_sensor(data.result);

                        return data;
                    },
                    error: function () {
                        console.log("error he ji");
                    }
                });
            });

            //------------------------------------------------------------------------------------------------------------------
            function fill_dropdown_sensor(result) {
                $("#id_sensor_list").html("<option value=''>--Select Sensor--</option>");
                for (index = 0; index < result.length; index++) {
                    var str_array = result[index].split(',');
                    $("#id_sensor_list").append($("<option />").val(str_array[0]).text(str_array[1]));
                }
            }

            //------------------------------------------------------------------------------------------------------------------
            var l_label = "Low";
            var l_Value = "";
            var l_color = "";

            var m_label = "Medium";
            var m_Value = "";
            var m_color = "";

            var h_label = "High";
            var h_Value = "";
            var h_endValue = "";
            var h_color = "";
            var unit_sensor = "";
            var custom_title = "";

            var audio_type = "";
            var first_warning = "";
            var second_warning = "";
            var third_warning = "";

            var first_audio = "";
            var second_audio = "";
            var third_audio = "";


            $("#btn_show").click(function () {
                var warning_validation = 2;
                $("#ip_hidden").val("");//empty the IP address on each click
                sensor_id = $("#id_sensor_list").val();
                if (sensor_id) {
                    $.ajax({
                        type: "get",
                        url: "{% url 'Strata:fetch_sensor_comman_values_ajax' %}",
                        data: {
                            'id': sensor_id
                        },
                        success: function (data) {
                                var strata=data.result;
                                $("#ip_hidden").val(strata.ip);
                                l_Value = parseFloat(strata.level1);
                                l_color = strata.level1_color;

                                m_Value = parseFloat(strata.level2);
                                m_color = strata.level2_color;

                                h_Value = parseFloat(strata.level3);
                                h_color = strata.level3_color;

                                audio_type = strata.audio_type;
                                first_warning = strata.level1_msg;
                                second_warning = strata.level2_msg;
                                third_warning = strata.level3_msg;

                                first_audio = strata.level1_audio;
                                second_audio = strata.level2_audio;
                                third_audio = strata.level3_audio;

                                fill_graph_sensor();
                        },
                        error: function () {
                            console.log("error");
                        }
                    });

                    $("#current_date").removeAttr('style');
                } else {
                    alert("Please choose sensor");
                }
            });

            //------------------------------------------------------------------------------------------------------------------

            function fill_graph_sensor() {

                var custom_name = $("#id_sensor_list").find(":selected").text();
                var dps = []; // dataPoints
                var chart = new CanvasJS.Chart("chartContainer", {
                    animationEnabled: true,
                    title: {
                        text: custom_name + " Live Data"
                    },

                    axisX: {
                        title: "Time",
                        valueFormatString: "hh:mm TT"
                    },
                    axisY: {
                        title: custom_title,

                        stripLines: [
                            {
                                label: l_label,
                                startValue: l_Value,
                                endValue: m_Value,
                                color: l_color
                            },
                            {
                                label: m_label,
                                startValue: m_Value,
                                endValue: h_Value,
                                color: m_color
                            },
                            {
                                label: h_label,
                                startValue: h_Value,
                                endValue: 5000,
                                color: h_color
                            }
                        ]

                    },
                    data: [{
                        type: "line",
                        name: "CPU Utilization",
                        connectNullData: true,
                        //nullDataLineDashType: "solid",
                        xValueType: "dateTime",
                        xValueFormatString: "DD MMM,YYYY hh:mm TT",
                        yValueFormatString: "#,##0.##\"mm\"",
                        dataPoints: dps
                    }]

                });
                //------------------------------------------------------------------------------------------------------------------
                var xVal = 0;
                var yVal = 100;
                var updateInterval = 4000;
                var dataLength = 20; // number of dataPoints visible at any point

                var updateChart = function () {
                    $.ajax({
                        type: "get",
                        url: "{% url 'Strata:fetch_sensor_values_ajax' %}",
                        data: {
                            'id': sensor_id
                        },
                        success: function (data) {
                            //console.log(data.result);
                            for (index = 0; index < data.result.length; index++) {
                                var str_array = data.result[index].split(',');
                                $("#unit_sensor").text(str_array[7]);
                                custom_title = str_array[7];
                                dps.push({
                                    x: Date.parse(str_array[2]),
                                    y: Number(str_array[6])
                                });
                                checkAndPlay(Number(str_array[6]))
                            }

                            //return data;
                        },
                        error: function () {
                            console.log("error he ji");
                        }
                    });


                    if (dps.length > dataLength) {
                        dps.shift();
                    }

                    chart.render();
                };
                updateChart(dataLength);
                setInterval(function () {
                    updateChart()
                }, updateInterval);
            }

            function checkAndPlay(sensorValue) {
                console.log(sensorValue);

                var loc = window.location;
                var baseUrl = loc.protocol + "//" + loc.hostname + (loc.port ? ":" + loc.port : "") + "/media/";

                if ((parseFloat(l_Value) < parseFloat(sensorValue)) && (parseFloat(sensorValue) < parseFloat(m_Value))) {//low level
                    $.toast({
                        heading: '<b>Strata Monitoring : First Level Warning</b>',
                        text: first_warning,
                        showHideTransition: 'fade',
                        position: 'bottom-right',
                        icon: 'error'
                    })
                    if (audio_type == "text2voice") {
                        Speak(first_warning, 9, 0.5);
                    } else {
                        path = baseUrl + first_audio;
                        var playNow = new Audio(path);
                        playNow.play();
                    }
                }
                if ((parseFloat(m_Value) < parseFloat(sensorValue)) && (parseFloat(sensorValue) < parseFloat(h_Value))) {//middle level
                    $.toast({
                        heading: '<b>Strata Monitoring : Second Level Warning </b>',
                        text: second_warning,
                        showHideTransition: 'fade',
                        position: 'bottom-right',
                        icon: 'error'
                    })
                    if (audio_type == "text2voice") {
                        console.log(second_warning)
                        Speak(second_warning, 9, 0.5);
                    } else {
                        path = baseUrl + second_audio;
                        var playNow = new Audio(path);
                        playNow.play();
                    }
                }

                if (parseFloat(h_Value) < parseFloat(sensorValue)) {//high level
                    $.toast({
                        heading: '<b>Strata Monitoring : Third Level Warning</b> ',
                        text: third_warning,
                        position: 'bottom-right',
                        showHideTransition: 'fade',
                        icon: 'error'
                    })
                    if (audio_type == "text2voice") {
                        Speak(third_warning, 9, 0.5);
                    } else {
                        path = baseUrl + third_audio;
                        var playNow = new Audio(path);
                        playNow.play();
                    }
                }
            }
        });
    </script>
{% endblock %}


