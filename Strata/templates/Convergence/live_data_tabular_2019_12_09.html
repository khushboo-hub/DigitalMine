{% extends "base.html" %}
{% block content %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.10.19/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/1.5.6/css/buttons.dataTables.min.css">
<div class="container">
    <div class="row">
        <section class="col-md-12">
            <h1 class="page-header"><b>STRATA LIVE DATA</b><small> Here we can view live strata data</small></h1>
            <div class="row">
                <div class="form-group">
                    <form class="form-horizontal" method="post" enctype="multipart/form-data">{% csrf_token %}

                        <div class="row">
                            <div class="col-md-2">
                                 <label for="" class="" id="">Choose Mine:</label>
                            </div>
                            <div class="col-md-4">
                                {{form.mine_name}}
                            </div>
                             <div class="col-md-2">
                                  <label for="" class="" id="">Choose Location:</label>
                            </div>
                            <div class="col-md-4">
                                <select class="form-control" id="id_location_list">
                                    <option>--Select Location--</option>
                                </select>
                            </div>
                        </div>
                        <br>
                        <div class="row">
                            <div class="col-md-2">
                                 <label for="" class="" id="">Choose Sensor:</label>
                            </div>
                            <div class="col-md-4">
                               <select class="form-control" id="id_sensor_list">
                                    <option value="">--Select Sensor--</option>
                                </select>
                            </div>
                             <div class="col-md-2">
                                 <label for="" class="" id="">Time Interval <small>  (in Seconds)</small>:</label>
                            </div>
                            <div class="col-md-4">
                                <input type="text" class="form-control" name="" value="30" id="id_interval">
                            </div>
                        </div>
                    </form>
                    <div class="row">
                         <div class="text-center">
                            <input type="submit" id="btn_show" class="btn btn-primary" value="Show"/>
                        </div>
                    </div>
                    <div class="row" style="margin-top:15px;">
                        <div class="col-md-4">
                            <label for="" class="" id="">Wireless data is comming from IP:</label>
                        </div>
                        <div class="col-md-4">
                            <input type="text" class="form-control" readonly id="ip_hidden">
                        </div>
                    </div>
                    <div class="col-md-12" style="margin-top:15px;">
                        <div class="table-responsive">
                            <table class="table table-bordered" id="sensor_content">
                                <thead>
                                    <tr>
                                        <th>Date Time</th>
                                        <th>Mine Name</th>
                                        <th>Location Name</th>
                                        <th>Sensor Name</th>
                                        <th>Sensor Value</th>
                                        <th>Sensor Unit</th>
                                        <th>Tag No</th>
                                    </tr>
                                </thead>
                                <tbody id="sensor_content_body">

                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>
</div>
 <!--<script src="https://code.jquery.com/jquery-3.3.1.js"></script>-->
 <script src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
 <script src="https://cdn.datatables.net/buttons/1.5.6/js/dataTables.buttons.min.js"></script>
 <script src="https://cdn.datatables.net/buttons/1.5.6/js/buttons.flash.min.js"></script>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
 <script src="https://cdn.datatables.net/buttons/1.5.6/js/buttons.html5.min.js"></script>
 <script src="https://cdn.datatables.net/buttons/1.5.6/js/buttons.print.min.js"></script>
<script>
    $("#id_mine_name").addClass('form-control');
    $("#id_mine_name").on("change",function(){
    mine_id=this.value;
    $.ajax({
            type:"get",
            url: "{% url 'Strata:fetch_location_ajax' %}",
            data: {
                     'id': mine_id
                   },
            success: function(data) {
                //console.log(data.result);
                //alert(data.result[0]);
                fill_dropdown(data.result);

                //return data;
                    },
            error: function(){
                    console.log("error he ji");
                 }
            });
});
function fill_dropdown(result){
    $("#id_location_list").html("<option>--Select Location--</option>");
    for (index = 0; index < result.length; index++) {
    //alert(result[index]);
    var str_array = result[index].split(',');
    //alert("id="+str_array[0]+":name="+str_array[1]);
    $("#id_location_list").append($("<option />").val(str_array[0]).text(str_array[1]));
    }
}
    $("#id_location_list").on("change",function(){
    location_id=this.value;
    $.ajax({
            type:"get",
            url: "{% url 'Strata:fetch_sensor_ajax' %}",
            data: {
                     'id': location_id
                   },
            success: function(data) {
                //console.log(data.result);
                //alert(data.result[0]);
                fill_dropdown_sensor(data.result);

                return data;
                    },
            error: function(){
                    console.log("error he ji");
                 }
            });
});
function fill_dropdown_sensor(result){
    $("#id_sensor_list").html("<option value=''>--Select Sensor--</option>");
    for (index = 0; index < result.length; index++) {
    //alert(result[index]);
    var str_array = result[index].split(',');
    //alert("id="+str_array[0]+":name="+str_array[1]);
    $("#id_sensor_list").append($("<option />").val(str_array[0]).text(str_array[1]));
    }
}
var interval_time=0;
$("#btn_show").click(function(){
    $("#btn_show").val("Please wait...");
    $("#btn_show").prop('disabled', true);
    interval_time=($("#id_interval").val()* 1000);
    sensor_id=$("#id_sensor_list").val();
    if(sensor_id == ""){
        alert("Please Choose Sensor");
        $("#btn_show").val("Show");
        $("#btn_show").prop('disabled', false);
    }else{
        $("#ip_hidden").val("");//empty the IP address on each click
        $("#sensor_content_body").empty();//empty the table on each click

        setInterval(function(){
                $.ajax({
                type:"get",
                url: "{% url 'Strata:fetch_sensor_values_ajax' %}",
                data: {
                         'id': sensor_id
                       },
                success: function(data) {
                    console.log(data.result);
                    //alert(data.result[0]);
                    //document.getElementById('sensor_content_body').style.backgroundColor='#FFFFFF';
                     $('tr').css({ 'background-color' : '#FFFFFF'});
                    fill_table_sensor(data.result);

                    return data;
                        },
                error: function(){
                        console.log("error he ji");
                     }
                });
        }, interval_time);//time in milliseconds
    }

});
    function fill_table_sensor(result){

        if ( $.fn.DataTable.isDataTable('#sensor_content') ) {
          $('#sensor_content').DataTable().destroy();
        }

        for (index = 0; index < result.length; index++) {
            var str_array = result[index].split(',');
            $("#ip_hidden").val(str_array[1]);
            $("#sensor_content").prepend($("<tr bgcolor='#ADFF2F'><td>"+str_array[2]+"</td><td>"+str_array[3]+"</td><td>"+str_array[4]+"</td><td>"+str_array[5]+"</td><td>"+str_array[6]+"</td><td>"+str_array[7]+"</td><td>"+str_array[8]+"</td></tr>"));
        }
        d_table();
        $("#btn_show").val("Show");
        $("#btn_show").prop('disabled', false);
    }
    $("#btn_print").click(function(){
        window.print();
    });

    function d_table(){
         $('#sensor_content').DataTable({
                paging: false,
                searching: true,
                "ordering": false,
                dom: 'Bfrtip',
                buttons: [
                    'copy', 'csv', 'excel', 'pdf', 'print'
                ]
         });
    }

$(document).ready(function() {
   d_table();
} );
</script>
{% endblock %}